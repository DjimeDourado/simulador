<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Miss√£o de Drone: An√°lise Din√¢mica com KML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet Map Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Geocoding (Search) Plugin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f5f5f5;
        }
        .card {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 1rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
        }
        .kpi-value {
            font-weight: 900;
            transition: color 0.3s ease;
        }
        .kpi-label {
            font-weight: 600;
            color: #a3a3a3;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 900;
            line-height: 1.2;
            text-align: center;
        }
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 8px;
            background: #444;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            background: #FFD700;
            border-radius: 50%;
            margin-top: -8px;
            cursor: pointer;
        }
        #map {
            height: 400px;
            border-radius: 0.5rem;
            border: 1px solid #444;
        }
        .leaflet-routing-container {
            display: none;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #2c2c2c; border: 1px solid #444; border-radius: 1rem;
            padding: 2rem; width: 90%; max-width: 700px; max-height: 90vh;
            overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .ai-button {
            background-image: linear-gradient(to right, #FF6B6B, #FFD700);
            color: #1a1a1a;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top-color: #fff; width: 24px; height: 24px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .leaflet-control-geocoder-form input {
            background-color: #444 !important;
            color: #fff !important;
            border-color: #555 !important;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center my-12">
            <h1 class="text-4xl md:text-6xl font-black text-white leading-tight">
                Simulador de Miss√£o de Drone
            </h1>
            <p class="mt-4 text-xl md:text-2xl text-slate-300 max-w-3xl mx-auto">
                An√°lise din√¢mica de GSD e √Årea de Projeto com Relat√≥rios IA.
            </p>
        </header>

        <main class="space-y-12">

            <section id="map-planner" class="card p-6 md:p-8">
                 <div class="flex flex-col sm:flex-row justify-between items-center">
                    <h2 class="text-2xl font-bold text-center text-white">1. Defina a √Årea do Projeto</h2>
                    <div class="mt-4 sm:mt-0">
                        <input type="file" id="kml-input" accept=".kml,.geojson,.json" class="hidden">
                        <label for="kml-input" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors">
                            Carregar Ficheiro
                        </label>
                    </div>
                 </div>
                 <p class="text-center text-slate-400 mt-2">Use a busca (üîç), desenhe um pol√≠gono (‚ñ°) ou carregue um ficheiro.</p>
                 <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6 items-center">
                     <div class="md:col-span-3">
                        <div id="map"></div>
                     </div>
                     <div class="text-center bg-slate-800 p-6 rounded-lg">
                        <p class="kpi-label">√Årea Calculada</p>
                        <p class="text-4xl font-black text-green-400 my-2"><span id="areaValue">0.0</span></p>
                        <p class="text-sm text-slate-400">hectares</p>
                     </div>
                 </div>
            </section>

             <section id="itinerary-planner" class="card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-center text-white">2. Planeamento da Desloca√ß√£o</h2>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label for="fuelConsumption" class="block text-sm font-medium text-slate-300">Consumo (L/100km)</label>
                        <input type="number" id="fuelConsumption" value="6.0" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white">
                    </div>
                    <div>
                        <label for="fuelPrice" class="block text-sm font-medium text-slate-300">Pre√ßo Combust√≠vel (‚Ç¨/L)</label>
                        <input type="number" id="fuelPrice" value="1.65" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white">
                    </div>
                    <div>
                        <label for="teamCost" class="block text-sm font-medium text-slate-300">Custo/Hora da Equipa (‚Ç¨)</label>
                        <input type="number" id="teamCost" value="10" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white">
                    </div>
                    <div>
                        <label for="tollCost" class="block text-sm font-medium text-slate-300">Portagens (ida e volta) (‚Ç¨)</label>
                        <input type="number" id="tollCost" value="0" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white">
                    </div>
                </div>
                <div class="mt-6 bg-slate-800 p-6 rounded-lg grid grid-cols-1 md:grid-cols-3 text-center gap-4">
                    <div>
                        <p id="distanceLabel" class="kpi-label">Dist√¢ncia</p>
                        <p class="text-2xl font-bold text-sky-400"><span id="routeDistance">--</span> km</p>
                    </div>
                    <div>
                        <p class="kpi-label">Tempo de Viagem</p>
                        <p class="text-2xl font-bold text-sky-400"><span id="routeTime">--</span></p>
                    </div>
                    <div>
                        <p class="kpi-label">Custo Total da Desloca√ß√£o</p>
                        <p class="text-2xl font-bold text-green-400">‚Ç¨ <span id="routeCost">--</span></p>
                    </div>
                </div>
                <div id="routingError" class="hidden text-center text-yellow-400 text-xs mt-2">O c√°lculo autom√°tico da rota falhou. A dist√¢ncia √© em linha reta.</div>
            </section>

            <section id="controls" class="card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-center text-white">3. Defina a Resolu√ß√£o (GSD)</h2>
                <div class="mt-6 max-w-2xl mx-auto">
                    <label for="gsdSlider" class="block text-center kpi-label">Ground Sample Distance (GSD)</label>
                    <div class="text-center text-4xl font-black text-[#FFD700] my-2">
                        <span id="gsdValue">1.00</span> cm/px
                    </div>
                    <input type="range" id="gsdSlider" min="0.5" max="5" value="1" step="0.05" class="w-full">
                </div>
            </section>

            <section id="results">
                <h2 class="section-title text-white">4. Analise os Resultados da Simula√ß√£o</h2>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="card p-6 border-t-4 border-yellow-400">
                        <h3 class="text-2xl font-bold text-center text-yellow-400">DJI Phantom 4 RTK</h3>
                        <div class="mt-6 grid grid-cols-2 gap-6 text-center">
                            <div><p class="kpi-label">Altitude de Voo</p><p id="p4rtk-altitude" class="text-4xl kpi-value text-yellow-400">0</p><p class="text-sm text-slate-400">metros</p></div>
                            <div><p class="kpi-label">Voos</p><p id="p4rtk-flights" class="text-4xl kpi-value text-yellow-400">0</p><p class="text-sm text-slate-400">baterias</p></div>
                            <div class="col-span-2"><p class="kpi-label">Tempo de Voo</p><p id="p4rtk-time" class="text-4xl kpi-value text-yellow-400">0</p><p class="text-sm text-slate-400">minutos</p></div>
                        </div>
                    </div>
                    <div class="card p-6 border-t-4 border-[#4ECDC4]">
                        <h3 class="text-2xl font-bold text-center text-[#4ECDC4]">DJI Mavic 3M</h3>
                        <div class="mt-6 grid grid-cols-2 gap-6 text-center">
                            <div><p class="kpi-label">Altitude de Voo</p><p id="m3m-altitude" class="text-4xl kpi-value text-[#4ECDC4]">0</p><p class="text-sm text-slate-400">metros</p></div>
                            <div><p class="kpi-label">Voos</p><p id="m3m-flights" class="text-4xl kpi-value text-[#4ECDC4]">0</p><p class="text-sm text-slate-400">baterias</p></div>
                            <div class="col-span-2"><p class="kpi-label">Tempo de Voo</p><p id="m3m-time" class="text-4xl kpi-value text-[#4ECDC4]">0</p><p class="text-sm text-slate-400">minutos</p></div>
                        </div>
                    </div>
                    <div class="card p-6 border-t-4 border-[#FF6B6B]">
                        <h3 class="text-2xl font-bold text-center text-[#FF6B6B]">DJI Matrice + P1</h3>
                        <div class="mt-6 grid grid-cols-2 gap-6 text-center">
                            <div><p class="kpi-label">Altitude de Voo</p><p id="m300-altitude" class="text-4xl kpi-value text-[#FF6B6B]">0</p><p class="text-sm text-slate-400">metros</p></div>
                            <div><p class="kpi-label">Voos</p><p id="m300-flights" class="text-4xl kpi-value text-[#FF6B6B]">0</p><p class="text-sm text-slate-400">pares de baterias</p></div>
                            <div class="col-span-2"><p class="kpi-label">Tempo de Voo</p><p id="m300-time" class="text-4xl kpi-value text-[#FF6B6B]">0</p><p class="text-sm text-slate-400">minutos</p></div>
                        </div>
                    </div>
                     <div class="card p-6 border-t-4 border-purple-500">
                        <h3 class="text-2xl font-bold text-center text-purple-400">Matrice + LiDAR</h3>
                        <div class="mt-6 grid grid-cols-2 gap-6 text-center">
                            <div><p class="kpi-label">Altitude de Voo</p><p id="lidar-altitude" class="text-4xl kpi-value text-purple-400">0</p><p class="text-sm text-slate-400">metros</p></div>
                            <div><p class="kpi-label">Voos</p><p id="lidar-flights" class="text-4xl kpi-value text-purple-400">0</p><p class="text-sm text-slate-400">pares de baterias</p></div>
                            <div class="col-span-2"><p class="kpi-label">Tempo de Voo</p><p id="lidar-time" class="text-4xl kpi-value text-purple-400">0</p><p class="text-sm text-slate-400">minutos</p></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="charts" class="card p-6 md:p-8">
                 <h2 class="section-title text-white">An√°lise Visual Comparativa</h2>
                 <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                     <div class="text-center"><h4 class="font-bold text-lg">Altitude (m)</h4><div class="chart-container"><canvas id="altitudeChart"></canvas></div></div>
                     <div class="text-center"><h4 class="font-bold text-lg">Tempo (minutos)</h4><div class="chart-container"><canvas id="timeChart"></canvas></div></div>
                     <div class="text-center"><h4 class="font-bold text-lg">N¬∫ de Voos</h4><div class="chart-container"><canvas id="flightsChart"></canvas></div></div>
                 </div>
            </section>
            
            <section id="verdict" class="card p-8">
                <h2 class="section-title text-white">5. Gere o seu Relat√≥rio de An√°lise</h2>
                <p class="text-center text-slate-400 mt-4 max-w-3xl mx-auto">Transforme esta simula√ß√£o num relat√≥rio t√©cnico profissional para apresentar aos seus clientes ou stakeholders.</p>
                <div class="mt-8 text-center">
                     <button class="ai-button font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity text-lg" onclick="openModal()">
                        ‚ú® Gerar Relat√≥rio de An√°lise com IA
                    </button>
                </div>
            </section>

        </main>

        <footer class="text-center mt-16 py-8 border-t border-slate-800">
            <p class="text-sm text-slate-500">Este simulador baseia-se em sobreposi√ß√µes de 80%/70%.</p>
        </footer>
    </div>

    <div id="aiModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold text-white">Assistente IA</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <p id="modalDescription" class="text-slate-400 mb-6"></p>
            <div id="modalForm">
                <div class="space-y-4">
                    <div>
                        <label for="projectName" class="block text-sm font-medium text-slate-300">Nome do Projeto</label>
                        <input type="text" id="projectName" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-yellow-500 focus:border-yellow-500" placeholder="Ex: Levantamento Topogr√°fico Fazenda Boa Vista">
                    </div>
                    <div>
                        <label for="mainObjective" class="block text-sm font-medium text-slate-300">Principal Objetivo do Projeto</label>
                        <input type="text" id="mainObjective" class="mt-1 block w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-yellow-500 focus:border-yellow-500" placeholder="Ex: Gera√ß√£o de ortofoto para projeto de engenharia">
                    </div>
                </div>
                <button id="generateBtn" onclick="generateReport()" class="ai-button w-full font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity mt-6 flex items-center justify-center">Gerar</button>
            </div>
            <div id="modalResult" class="hidden">
                <div id="loadingSpinner" class="flex justify-center items-center my-8"><div class="spinner"></div><p class="ml-4 text-slate-300">A IA est√° a redigir o documento...</p></div>
                <div id="reportOutput" class="hidden">
                    <h4 class="text-xl font-bold text-white mb-2">Rascunho do Documento:</h4>
                    <textarea readonly id="reportText" class="w-full h-64 bg-slate-800 border border-slate-600 rounded-md p-3 text-slate-300 text-sm"></textarea>
                    <div class="flex gap-4 mt-4">
                        <button onclick="copyToClipboard()" class="bg-green-600 w-full text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Copiar Texto</button>
                        <button onclick="resetModal()" class="bg-slate-600 w-full text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors">Gerar Novo</button>
                    </div>
                </div>
                 <div id="error-message" class="hidden text-center p-4 bg-red-900/50 border border-red-500 rounded-lg"><p class="text-red-400">Ocorreu um erro. Por favor, tente novamente.</p></div>
            </div>
        </div>
    </div>

    <script>
    window.addEventListener('load', function() {
        const P4RTK_COLOR = '#facc15'; // yellow-400
        const M3M_COLOR = '#4ECDC4';
        const M300_COLOR = '#FF6B6B';
        const LIDAR_COLOR = '#a855f7'; // purple-500
        const TEXT_COLOR = '#f5f5f5';
        const GRID_COLOR = '#444444';

        const droneParams = {
            p4rtk: { sensorWidth: 13.2, focalLength: 8.8, imageWidth: 5472, flightSpeed: 10, batteryTime: 23 },
            m3m: { sensorWidth: 17.3, focalLength: 12.29, imageWidth: 5280, flightSpeed: 10, batteryTime: 34 },
            m300: { sensorWidth: 35.9, focalLength: 35, imageWidth: 8192, flightSpeed: 15, batteryTime: 30 },
            lidar: { 
                camera: { sensorWidth: 23.5, focalLength: 20, imageWidth: 6000 }, // Sony A6000
                flightSpeed: 6, 
                batteryTime: 24
            }
        };

        const missionParams = {
            area: 0, 
            overlapF: 0.80,
            overlapS: 0.70
        };

        let altitudeChart, timeChart, flightsChart;
        let map, drawnItems, routingControl;
        let lastRouteSummary = null;
        const startPoint = L.latLng(40.354755, -8.452600); // Geolayer Coords

        function calculatePhotogrammetryMission(drone, gsd_cm, area_m2) {
            if (area_m2 <= 0) return { altitude: 0, totalTimeMinutes: 0, flights: 0 };
            const gsd_m = gsd_cm / 100;
            const H = (gsd_m * drone.focalLength * drone.imageWidth) / drone.sensorWidth;
            const footprintW = (H * drone.sensorWidth) / drone.focalLength;
            
            const lineSpacing = footprintW * (1 - missionParams.overlapS);
            if (lineSpacing <= 0) return { altitude: H, totalTimeMinutes: Infinity, flights: Infinity };
            
            const totalDistance = (area_m2 / lineSpacing);
            const totalTimeSeconds = totalDistance / drone.flightSpeed;
            const totalTimeMinutes = totalTimeSeconds / 60;
            const flights = Math.ceil(totalTimeMinutes / drone.batteryTime);

            return {
                altitude: H,
                totalTimeMinutes: totalTimeMinutes,
                flights: flights
            };
        }

        function calculateLiDARMission(drone, gsd_cm, area_m2) {
            if (area_m2 <= 0) return { altitude: 0, totalTimeMinutes: 0, flights: 0 };
            const gsd_m = gsd_cm / 100;
            const H = (gsd_m * drone.camera.focalLength * drone.camera.imageWidth) / drone.camera.sensorWidth;

            const footprintW = (H * drone.camera.sensorWidth) / drone.camera.focalLength;
            const lineSpacing = footprintW * (1 - missionParams.overlapS);
            if (lineSpacing <= 0) return { altitude: H, totalTimeMinutes: Infinity, flights: Infinity };
            
            const totalDistance = (area_m2 / lineSpacing);
            const totalTimeSeconds = totalDistance / drone.flightSpeed;
            const totalTimeMinutes = totalTimeSeconds / 60;
            const flights = Math.ceil(totalTimeMinutes / drone.batteryTime);

            return {
                altitude: H,
                totalTimeMinutes: totalTimeMinutes,
                flights: flights
            };
        }

        function updateInfographic() {
            const gsdSlider = document.getElementById('gsdSlider');
            const gsdValue = document.getElementById('gsdValue');
            const currentGsd = parseFloat(gsdSlider.value);
            gsdValue.textContent = currentGsd.toFixed(2);

            const p4rtkResults = calculatePhotogrammetryMission(droneParams.p4rtk, currentGsd, missionParams.area);
            const m3mResults = calculatePhotogrammetryMission(droneParams.m3m, currentGsd, missionParams.area);
            const m300Results = calculatePhotogrammetryMission(droneParams.m300, currentGsd, missionParams.area);
            const lidarResults = calculateLiDARMission(droneParams.lidar, currentGsd, missionParams.area);

            document.getElementById('p4rtk-altitude').textContent = p4rtkResults.altitude.toFixed(1);
            document.getElementById('p4rtk-time').textContent = isFinite(p4rtkResults.totalTimeMinutes) ? p4rtkResults.totalTimeMinutes.toFixed(0) : '‚àû';
            document.getElementById('p4rtk-flights').textContent = isFinite(p4rtkResults.flights) ? p4rtkResults.flights : '‚àû';

            document.getElementById('m3m-altitude').textContent = m3mResults.altitude.toFixed(1);
            document.getElementById('m3m-time').textContent = isFinite(m3mResults.totalTimeMinutes) ? m3mResults.totalTimeMinutes.toFixed(0) : '‚àû';
            document.getElementById('m3m-flights').textContent = isFinite(m3mResults.flights) ? m3mResults.flights : '‚àû';

            document.getElementById('m300-altitude').textContent = m300Results.altitude.toFixed(1);
            document.getElementById('m300-time').textContent = isFinite(m300Results.totalTimeMinutes) ? m300Results.totalTimeMinutes.toFixed(0) : '‚àû';
            document.getElementById('m300-flights').textContent = isFinite(m300Results.flights) ? m300Results.flights : '‚àû';

            document.getElementById('lidar-altitude').textContent = lidarResults.altitude.toFixed(1);
            document.getElementById('lidar-time').textContent = isFinite(lidarResults.totalTimeMinutes) ? lidarResults.totalTimeMinutes.toFixed(0) : '‚àû';
            document.getElementById('lidar-flights').textContent = isFinite(lidarResults.flights) ? lidarResults.flights : '‚àû';
            
            updateCharts(p4rtkResults, m3mResults, m300Results, lidarResults);
        }

        function createChart(ctx, label, p4rtkData, m3mData, m300Data, lidarData) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['P4 RTK', 'Mavic 3M', 'Matrice P1', 'Matrice LiDAR'],
                    datasets: [{
                        label: label,
                        data: [p4rtkData, m3mData, m300Data, lidarData],
                        backgroundColor: [P4RTK_COLOR, M3M_COLOR, M300_COLOR, LIDAR_COLOR],
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: TEXT_COLOR }, grid: { color: GRID_COLOR } },
                        x: { ticks: { color: TEXT_COLOR }, grid: { display: false } }
                    }
                }
            });
        }

        function updateCharts(p4rtk, m3m, m300, lidar) {
            if (altitudeChart) altitudeChart.destroy();
            if (timeChart) timeChart.destroy();
            if (flightsChart) flightsChart.destroy();

            altitudeChart = createChart(document.getElementById('altitudeChart').getContext('2d'), 'Altitude (m)', p4rtk.altitude, m3m.altitude, m300.altitude, lidar.altitude);
            timeChart = createChart(document.getElementById('timeChart').getContext('2d'), 'Tempo (min)', isFinite(p4rtk.totalTimeMinutes) ? p4rtk.totalTimeMinutes : 0, isFinite(m3m.totalTimeMinutes) ? m3m.totalTimeMinutes : 0, isFinite(m300.totalTimeMinutes) ? m300.totalTimeMinutes : 0, isFinite(lidar.totalTimeMinutes) ? lidar.totalTimeMinutes : 0);
            flightsChart = createChart(document.getElementById('flightsChart').getContext('2d'), 'N¬∫ de Voos', isFinite(p4rtk.flights) ? p4rtk.flights : 0, isFinite(m3m.flights) ? m3m.flights : 0, isFinite(m300.flights) ? m300.flights : 0, isFinite(lidar.flights) ? lidar.flights : 0);
        }

        function initMap() {
            const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '&copy; Google' });
            const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '&copy; Google' });
            const googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '&copy; Google' });

            map = L.map('map').setView([39.5, -8.0], 7);
            googleStreets.addTo(map);

            const baseMaps = { "Google Streets": googleStreets, "Google Satellite": googleSat, "Google Terrain": googleTerrain };
            L.control.layers(baseMaps).addTo(map);

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: {
                    polygon: { allowIntersection: false, shapeOptions: { color: '#FFD700' } },
                    polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
                }
            });
            map.addControl(drawControl);

            L.Control.geocoder().addTo(map);

            map.on(L.Draw.Event.CREATED, function (e) {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                updateAreaFromLayers(drawnItems);
            });

            map.on(L.Draw.Event.EDITED, function () { updateAreaFromLayers(drawnItems); });
            map.on(L.Draw.Event.DELETED, function() {
                missionParams.area = 0;
                document.getElementById('areaValue').textContent = "0.0";
                if(routingControl) routingControl.setWaypoints([]);
                updateInfographic();
            });
        }
        
        function updateAreaFromLayers(layerGroup) {
            let totalArea = 0;
            let center;
            layerGroup.eachLayer(layer => {
                if (layer instanceof L.Polygon) {
                    const latlngs = layer.getLatLngs()[0];
                    if (latlngs && L.GeometryUtil) {
                        totalArea += L.GeometryUtil.geodesicArea(latlngs);
                        center = layer.getBounds().getCenter();
                    }
                } else if (layer instanceof L.FeatureGroup || layer instanceof L.LayerGroup) {
                     layer.eachLayer(function(sublayer) {
                        if (sublayer.getLatLngs) {
                             const latlngs = sublayer.getLatLngs()[0];
                            if (latlngs && L.GeometryUtil) {
                                totalArea += L.GeometryUtil.geodesicArea(latlngs);
                            }
                        }
                    });
                    if (layer.getBounds().isValid()) {
                        center = layer.getBounds().getCenter();
                    }
                }
            });

            missionParams.area = totalArea;
            document.getElementById('areaValue').textContent = (totalArea / 10000).toFixed(1);
            updateInfographic();
            if(center) updateRoute(center);
        }

        function updateRoute(destination) {
            if (routingControl) {
                routingControl.setWaypoints([startPoint, destination]);
            } else {
                routingControl = L.Routing.control({
                    waypoints: [startPoint, destination],
                    routeWhileDragging: false,
                    show: false,
                    addWaypoints: false,
                    lineOptions: { styles: [{color: '#FF6B6B', opacity: 0.8, weight: 5}] }
                }).on('routesfound', function(e) {
                    const route = e.routes[0];
                    document.getElementById('routingError').classList.add('hidden');
                    document.getElementById('distanceLabel').textContent = 'Dist√¢ncia';
                    updateItineraryCost(route.summary);
                }).on('routingerror', function(e) {
                    console.error("Routing Error:", e.error);
                    document.getElementById('routingError').classList.remove('hidden');
                    document.getElementById('distanceLabel').textContent = 'Dist√¢ncia (linha reta)';
                    const distance = startPoint.distanceTo(destination) / 1000;
                    updateItineraryCost({ totalDistance: distance * 1000, totalTime: NaN });
                }).addTo(map);
            }
        }

        function updateItineraryCost(summary) {
            if (!summary) return;
            lastRouteSummary = summary; 

            const distanceKm = summary.totalDistance / 1000;
            const timeSec = summary.totalTime;

            const consumption = parseFloat(document.getElementById('fuelConsumption').value);
            const price = parseFloat(document.getElementById('fuelPrice').value);
            const costHour = parseFloat(document.getElementById('teamCost').value);
            const tollCost = parseFloat(document.getElementById('tollCost').value) || 0;

            const fuelCost = (distanceKm / 100) * consumption * price;
            
            let timeCost = 0;
            if (!isNaN(timeSec)) {
                timeCost = (timeSec / 3600) * costHour;
                const hours = Math.floor(timeSec / 3600);
                const minutes = Math.round((timeSec % 3600) / 60);
                document.getElementById('routeTime').textContent = `${hours}h ${minutes}m`;
            } else {
                document.getElementById('routeTime').textContent = 'N/A';
            }
            
            const totalCost = (fuelCost + timeCost) * 2 + tollCost;

            document.getElementById('routeDistance').textContent = distanceKm.toFixed(1);
            document.getElementById('routeCost').textContent = totalCost.toFixed(2);
        }
        
        function kml2geojson(kml) {
            const geojson = {
                type: 'FeatureCollection',
                features: []
            };
            const placemarks = kml.getElementsByTagName('Placemark');
            for (let i = 0; i < placemarks.length; i++) {
                const placemark = placemarks[i];
                const polygons = placemark.getElementsByTagName('Polygon');
                for (let j = 0; j < polygons.length; j++) {
                    const coordsStr = polygons[j].getElementsByTagName('coordinates')[0].childNodes[0].nodeValue.trim();
                    const coords = coordsStr.split(/\s+/).map(coordStr => {
                        const c = coordStr.split(',');
                        return [parseFloat(c[0]), parseFloat(c[1])];
                    });
                    geojson.features.push({
                        type: 'Feature',
                        geometry: {
                            type: 'Polygon',
                            coordinates: [coords]
                        },
                        properties: {}
                    });
                }
            }
            return geojson;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                drawnItems.clearLayers();

                try {
                    const extension = file.name.split('.').pop().toLowerCase();
                    let geojson;

                    if (extension === 'kml') {
                        const kml = new DOMParser().parseFromString(content, 'text/xml');
                        geojson = kml2geojson(kml);
                    } else if (extension === 'geojson' || extension === 'json') {
                        geojson = JSON.parse(content);
                    } else {
                        alert("Formato de ficheiro n√£o suportado. Use .kml ou .geojson.");
                        return;
                    }
                    
                    const customLayer = L.geoJSON(geojson, {
                         style: { color: '#FFD700', weight: 2, opacity: 0.8, fillOpacity: 0.1 }
                    });

                    drawnItems.addLayer(customLayer);
                    map.fitBounds(customLayer.getBounds());
                    updateAreaFromLayers(customLayer);

                } catch (err) {
                     console.error("Erro ao processar o ficheiro:", err);
                     alert("N√£o foi poss√≠vel ler o ficheiro. Verifique se est√° corretamente formatado.");
                }
            };
            reader.readAsText(file);
        }

        initMap();
        updateInfographic();
        document.getElementById('gsdSlider').addEventListener('input', updateInfographic);
        document.getElementById('kml-input').addEventListener('change', handleFileUpload);
        ['fuelConsumption', 'fuelPrice', 'teamCost', 'tollCost'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                if (lastRouteSummary) {
                    updateItineraryCost(lastRouteSummary);
                }
            });
        });
        
        // AI Modal Logic
        const modal = document.getElementById('aiModal');
        const modalForm = document.getElementById('modalForm');
        const modalResult = document.getElementById('modalResult');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const reportOutput = document.getElementById('reportOutput');
        const errorMessage = document.getElementById('error-message');

        window.openModal = function() {
            document.getElementById('modalTitle').textContent = 'Assistente de Relat√≥rios IA';
            document.getElementById('modalDescription').textContent = 'Preencha os detalhes para gerar um relat√≥rio t√©cnico baseado na simula√ß√£o atual.';
            document.getElementById('generateBtn').textContent = 'Gerar Relat√≥rio';
            modal.classList.add('visible');
            resetModal();
        }

        window.closeModal = function() {
            modal.classList.remove('visible');
        }

        function resetModal() {
            modalForm.style.display = 'block';
            modalResult.style.display = 'none';
            reportOutput.style.display = 'none';
            loadingSpinner.style.display = 'none';
            errorMessage.style.display = 'none';
            document.getElementById('projectName').value = '';
            document.getElementById('mainObjective').value = '';
            document.getElementById('reportText').value = '';
        }

        window.copyToClipboard = function() {
            const textarea = document.getElementById('reportText');
            textarea.select();
            document.execCommand('copy');
        }

        window.generateReport = async function() {
            const projectName = document.getElementById('projectName').value || 'N√£o especificado';
            const mainObjective = document.getElementById('mainObjective').value || 'N√£o especificado';
            const currentGsd = document.getElementById('gsdSlider').value;
            const currentArea = document.getElementById('areaValue').textContent;
            
            const p4rtkAlt = document.getElementById('p4rtk-altitude').textContent;
            const p4rtkTime = document.getElementById('p4rtk-time').textContent;
            const p4rtkFlights = document.getElementById('p4rtk-flights').textContent;
            const m3mAlt = document.getElementById('m3m-altitude').textContent;
            const m3mTime = document.getElementById('m3m-time').textContent;
            const m3mFlights = document.getElementById('m3m-flights').textContent;
            const m300Alt = document.getElementById('m300-altitude').textContent;
            const m300Time = document.getElementById('m300-time').textContent;
            const m300Flights = document.getElementById('m300-flights').textContent;
            const lidarAlt = document.getElementById('lidar-altitude').textContent;
            const lidarTime = document.getElementById('lidar-time').textContent;
            const lidarFlights = document.getElementById('lidar-flights').textContent;

            modalForm.style.display = 'none';
            modalResult.style.display = 'block';
            loadingSpinner.style.display = 'flex';
            reportOutput.style.display = 'none';
            errorMessage.style.display = 'none';

            const prompt = `Aja como um consultor s√©nior de tecnologia geoespacial. Escreva um relat√≥rio de viabilidade t√©cnica, em Portugu√™s, para a escolha do drone mais adequado com base na seguinte simula√ß√£o.

                **Contexto do Projeto:**
                - **Nome do Projeto:** ${projectName}
                - **Objetivo Principal:** ${mainObjective}

                **Par√¢metros da Simula√ß√£o:**
                - **√Årea do Projeto:** ${currentArea} hectares
                - **Resolu√ß√£o Fotogram√©trica (GSD) Requerida:** ${currentGsd} cm/px

                **Dados Comparativos da Simula√ß√£o:**
                 - **DJI Phantom 4 RTK:** Altitude: ${p4rtkAlt} m, Tempo de Voo: ${p4rtkTime} min, Voos: ${p4rtkFlights}
                - **DJI Mavic 3M:** Altitude: ${m3mAlt} m, Tempo de Voo: ${m3mTime} min, Voos: ${m3mFlights}
                - **DJI Matrice 300 + P1 (Fotogrametria):** Altitude: ${m300Alt} m, Tempo de Voo: ${m300Time} min, Voos: ${m300Flights}
                - **DJI Matrice 300 + L1 (LiDAR):** Altitude: ${lidarAlt} m, Tempo de Voo: ${lidarTime} min, Voos: ${lidarFlights}

                **Estrutura do Relat√≥rio:**
                1.  **Assunto:** Relat√≥rio de Viabilidade T√©cnica para o Projeto ${projectName}.
                2.  **Sum√°rio Executivo:** Resuma o desafio e a recomenda√ß√£o final.
                3.  **An√°lise Comparativa de Desempenho:** Compare os quatro sistemas (tr√™s de fotogrametria e um LiDAR) usando os dados da simula√ß√£o. Explique as diferen√ßas de efici√™ncia.
                4.  **An√°lise Log√≠stica:** Discuta o que os "Voos Necess√°rios" e "Tempo de Voo" significam para cada plataforma.
                5.  **Recomenda√ß√£o Final:** Declare qual equipamento √© o mais recomendado para este cen√°rio espec√≠fico e porqu√™.

                Mantenha um tom formal, t√©cnico e focado no valor para o neg√≥cio.`;
            
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "API_KEY"; // SUBSTITUA PELA SUA CHAVE DE API
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) { 
                    const errorBody = await response.text();
                    console.error("Erro da API:", response.status, response.statusText, errorBody);
                    throw new Error(`HTTP error! status: ${response.status}`); 
                }

                const result = await response.json();
                
                let text = '';
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                } else {
                     throw new Error('Resposta da API inv√°lida ou vazia.');
                }

                document.getElementById('reportText').value = text;
                loadingSpinner.style.display = 'none';
                reportOutput.style.display = 'block';

            } catch (error) {
                console.error('Erro ao chamar a API Gemini:', error);
                loadingSpinner.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }
    });
    </script>
</body>
</html>
